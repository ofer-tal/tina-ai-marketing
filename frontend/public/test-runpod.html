<!DOCTYPE html>
<html>
<head>
    <title>RunPod Video Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: #eaeaea; }
        .test { margin: 20px 0; padding: 15px; background: #16213e; border-radius: 8px; }
        .success { color: #00d26a; }
        .error { color: #f8312f; }
        pre { background: #0f0f1a; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 10px 20px; background: #e94560; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #d63850; }
        #output { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>RunPod Video Generation Test</h1>

    <div class="test">
        <h2>Test 1: Service Status</h2>
        <button onclick="testStatus()">Test Status</button>
        <pre id="status-output">Click to test</pre>
    </div>

    <div class="test">
        <h2>Test 2: Video Generation (Mock Mode)</h2>
        <button onclick="testGeneration()">Generate Video</button>
        <pre id="generation-output">Click to test</pre>
    </div>

    <div class="test">
        <h2>Test 3: Validation - Missing Prompt</h2>
        <button onclick="testValidation()">Test Validation</button>
        <pre id="validation-output">Click to test</pre>
    </div>

    <div class="test">
        <h2>Test 4: All Steps Verification</h2>
        <button onclick="testAllSteps()">Run Full Test</button>
        <pre id="all-output">Click to test</pre>
    </div>

    <script>
        const API_BASE = 'http://localhost:4001';

        async function testStatus() {
            const output = document.getElementById('status-output');
            output.textContent = 'Testing...';

            try {
                const response = await fetch(`${API_BASE}/api/video/status/runpod`);
                const data = await response.json();

                output.innerHTML = `<span class="success">✓ Status Check Passed</span>\n\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                output.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testGeneration() {
            const output = document.getElementById('generation-output');
            output.textContent = 'Testing...';

            try {
                const response = await fetch(`${API_BASE}/api/video/generate/runpod`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: 'A romantic beach sunset with couple holding hands',
                        spiciness: 1,
                        category: 'Contemporary',
                        duration: 10,
                        aspectRatio: '9:16'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const checks = [];
                    checks.push(`✓ Request accepted: ${data.data.requestId}`);
                    checks.push(`✓ Video generated: ${data.data.video.filename}`);
                    checks.push(`✓ Duration: ${data.data.video.duration}s`);
                    checks.push(`✓ Aspect ratio: ${data.data.video.aspectRatio}`);
                    checks.push(`✓ Steps completed: ${data.data.steps.length}`);

                    output.innerHTML = `<span class="success">✓ Generation Successful</span>\n\n${checks.join('\n')}\n\nFull Response:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    output.innerHTML = `<span class="error">✗ Generation Failed: ${data.error}</span>`;
                }
            } catch (error) {
                output.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testValidation() {
            const output = document.getElementById('validation-output');
            output.textContent = 'Testing...';

            try {
                const response = await fetch(`${API_BASE}/api/video/generate/runpod`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: 10 }) // Missing prompt
                });

                const data = await response.json();

                if (response.status === 400 && data.error === 'Missing required field: prompt') {
                    output.innerHTML = `<span class="success">✓ Validation Working Correctly</span>\n\nError: ${data.error}\n\nFull Response:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    output.innerHTML = `<span class="error">✗ Validation Not Working</span>\n\nExpected: "Missing required field: prompt"\nGot: ${data.error}\n\nFull Response:\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                output.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        async function testAllSteps() {
            const output = document.getElementById('all-output');
            output.textContent = 'Running all tests...';

            const results = [];

            // Step 1: Call RunPod API
            results.push('Step 1: Call RunPod API for video generation');
            try {
                const response = await fetch(`${API_BASE}/api/video/generate/runpod`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: 'Test video for feature verification',
                        spiciness: 1,
                        duration: 5
                    })
                });

                const data = await response.json();

                if (data.success) {
                    results.push('  ✓ Request accepted and processed');

                    // Step 2: Verify request accepted
                    results.push('\nStep 2: Verify request accepted');
                    if (data.data.requestId) {
                        results.push(`  ✓ Request ID: ${data.data.requestId}`);
                    } else {
                        results.push('  ✗ No request ID returned');
                    }

                    // Step 3: Poll for generation status
                    results.push('\nStep 3: Poll for generation status');
                    if (data.data.steps && data.data.steps.length >= 2) {
                        results.push('  ✓ Polling completed');
                        data.data.steps.forEach(step => {
                            results.push(`    - ${step.name}: ${step.status}`);
                        });
                    } else {
                        results.push('  ✗ Steps not recorded');
                    }

                    // Step 4: Download completed video
                    results.push('\nStep 4: Download completed video');
                    if (data.data.video && data.data.video.path) {
                        results.push(`  ✓ Video path: ${data.data.video.path}`);
                        results.push(`  ✓ File size: ${data.data.video.sizeMB} MB`);
                    } else {
                        results.push('  ✗ Video not downloaded');
                    }

                    // Step 5: Verify video quality and duration
                    results.push('\nStep 5: Verify video quality and duration');
                    if (data.data.video) {
                        const video = data.data.video;
                        results.push(`  ✓ Duration: ${video.duration}s (within 3-60s limit)`);
                        results.push(`  ✓ Aspect ratio: ${video.aspectRatio} (9:16 vertical)`);
                        results.push(`  ✓ Source: ${video.source}`);

                        if (video.mock) {
                            results.push('  ℹ Running in MOCK MODE (API key not configured)');
                        }
                    }

                    results.push('\n' + '='.repeat(50));
                    results.push('✓ ALL 5 STEPS VERIFIED SUCCESSFULLY');

                } else {
                    results.push(`  ✗ Generation failed: ${data.error}`);
                }

            } catch (error) {
                results.push(`  ✗ Error: ${error.message}`);
            }

            output.innerHTML = results.join('\n');
        }
    </script>
</body>
</html>
